"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1414],{61414:function(t,e,i){i.d(e,{HB:function(){return u},qr:function(){return s},tN:function(){return l}});var n=i(8433),a=i(31421),o=i(30189);let r={user:null,isAuthenticated:!1,wallet:null,transactions:[],donations:[],donationLinks:[],recentDonations:[],obsSettings:null,dashboardStats:null,isLoading:!1,error:null},s=(0,n.Ue)()((0,a.mW)((0,a.tJ)((t,e)=>({...r,setUser:e=>t({user:e,isAuthenticated:!!e}),setAuthenticated:e=>t({isAuthenticated:e}),refreshUser:async()=>{try{let{isValid:e,user:i}=await (0,o.validateAuthToken)();e&&i&&t({user:i,isAuthenticated:!0})}catch(t){console.error("Failed to refresh user data:",t)}},updateUserRole:i=>{let{user:n}=e();n&&t({user:{...n,role:i}})},initializeAuth:async()=>{var i,n,a,r;try{console.log("Initializing authentication...");let a=e();if(console.log("Current persisted state:",{hasUser:!!a.user,isAuthenticated:a.isAuthenticated}),(0,o.pw)()){console.log("Token is expired, clearing auth state"),(0,o.H6)(),t({user:null,isAuthenticated:!1});return}let r=(0,o.hV)();if(a.user&&a.isAuthenticated&&r){console.log("Found persisted user and token, validating...");try{let{isValid:e,user:i,isNetworkError:n}=await (0,o.validateAuthToken)();if(console.log("Token validation result:",{isValid:e,user:i?"exists":"null",isNetworkError:!!n}),e&&i){console.log("Token valid, keeping existing user:",i.name),t({user:{...a.user,...i},isAuthenticated:!0});return}if(n){console.log("Network error during validation, keeping current auth state");return}console.log("Token invalid, clearing auth state"),(0,o.H6)(),t({user:null,isAuthenticated:!1});return}catch(e){console.error("Token validation error:",e),(null==e?void 0:null===(i=e.response)||void 0===i?void 0:i.status)===401||(null==e?void 0:null===(n=e.response)||void 0===n?void 0:n.status)===403?(console.log("Authentication error, clearing auth state"),(0,o.H6)(),t({user:null,isAuthenticated:!1})):console.log("Network error, keeping existing auth state");return}}let s=!!r;if(!a.user&&s){console.log("Token present but no user in state, validating to populate user...");let{isValid:e,user:i,isNetworkError:n}=await (0,o.validateAuthToken)();if(console.log("Token validation result:",{isValid:e,user:i?"exists":"null",isNetworkError:!!n}),e&&i){console.log("Validation successful, setting authenticated user:",i.name),t({user:i,isAuthenticated:!0});return}if(n){console.log("Network error during validation with token; keep isAuthenticated true and retry later"),t({isAuthenticated:!0});return}console.log("Token invalid; clearing auth state"),(0,o.H6)(),t({user:null,isAuthenticated:!1});return}a.user||s||(console.log("No token and no user; ensuring logged out"),t({user:null,isAuthenticated:!1}))}catch(e){console.error("Authentication initialization error:",e),(null==e?void 0:null===(a=e.response)||void 0===a?void 0:a.status)===401||(null==e?void 0:null===(r=e.response)||void 0===r?void 0:r.status)===403?(console.log("Authentication error, clearing auth state"),(0,o.H6)(),t({user:null,isAuthenticated:!1})):console.log("Network or other error, maintaining current auth state")}},setWallet:e=>t({wallet:e}),updateWalletBalance:i=>{let{wallet:n}=e();n&&t({wallet:{...n,balance:n.balance+i}})},addTransaction:i=>{let{transactions:n}=e();t({transactions:[i,...n]})},setTransactions:e=>t({transactions:e}),addDonation:i=>{let{donations:n,recentDonations:a}=e();t({donations:[i,...n],recentDonations:[i,...a.slice(0,9)]})},setDonations:e=>t({donations:e}),addDonationLink:i=>{let{donationLinks:n}=e();t({donationLinks:[i,...n||[]]})},updateDonationLink:(i,n)=>{let{donationLinks:a}=e();t({donationLinks:(a||[]).map(t=>t.id===i?{...t,...n}:t)})},removeDonationLink:i=>{let{donationLinks:n}=e();t({donationLinks:(n||[]).filter(t=>t.id!==i)})},setDonationLinks:e=>t({donationLinks:e||[]}),setOBSSettings:e=>t({obsSettings:e}),updateOBSSettings:i=>{let{obsSettings:n}=e();n&&t({obsSettings:{...n,...i}})},setDashboardStats:e=>t({dashboardStats:e}),setLoading:e=>t({isLoading:e}),setError:e=>t({error:e}),clearError:()=>t({error:null}),reset:()=>t(r)}),{name:"auth-store",partialize:t=>({user:t.user,isAuthenticated:t.isAuthenticated,wallet:t.wallet,transactions:t.transactions,donations:t.donations,donationLinks:t.donationLinks,obsSettings:t.obsSettings})}))),l=(0,n.Ue)()((0,a.mW)((0,a.tJ)(t=>({isAuthenticating:!1,authError:null,login:async(e,i)=>{t({isAuthenticating:!0,authError:null});try{let t=await o.x1.auth.login(e,i);if(t&&t.access_token&&t.user)(0,o.uB)(t.access_token),s.getState().setUser(t.user),s.getState().setAuthenticated(!0);else throw Error("Invalid response format")}catch(i){var n,a;let e=(null===(a=i.response)||void 0===a?void 0:null===(n=a.data)||void 0===n?void 0:n.message)||i.message||"Login failed";throw t({authError:e}),Error(e)}finally{t({isAuthenticating:!1})}},register:async e=>{t({isAuthenticating:!0,authError:null});try{let t=e.name.trim().split(" "),i=t[0]||"",n=t.slice(1).join(" ")||"";if(i&&!n&&(n="User"),i.length<2)throw Error("First name must be at least 2 characters long");if(n.length<2)throw Error("Last name must be at least 2 characters long");let a={email:e.email,password:e.password,firstName:i,lastName:n,role:e.role},r=await o.x1.auth.register(a.email,a.password,a.firstName,a.lastName,a.role);if(r&&r.access_token&&r.user)(0,o.uB)(r.access_token),s.getState().setUser(r.user),s.getState().setAuthenticated(!0);else throw Error("Registration failed")}catch(a){var i,n;let e=(null===(n=a.response)||void 0===n?void 0:null===(i=n.data)||void 0===i?void 0:i.message)||a.message||"Registration failed";throw t({authError:e}),Error(e)}finally{t({isAuthenticating:!1})}},logout:()=>{o.x1.auth.logout().catch(console.error),(0,o.H6)(),s.getState().reset(),t({isAuthenticating:!1,authError:null})},forgotPassword:async e=>{t({isAuthenticating:!0,authError:null});try{await new Promise(t=>setTimeout(t,1e3))}catch(a){var i,n;let e=(null===(n=a.response)||void 0===n?void 0:null===(i=n.data)||void 0===i?void 0:i.message)||a.message||"Failed to send reset email";throw t({authError:e}),Error(e)}finally{t({isAuthenticating:!1})}},resetPassword:async(e,i)=>{t({isAuthenticating:!0,authError:null});try{await new Promise(t=>setTimeout(t,1e3))}catch(i){var n,a;let e=(null===(a=i.response)||void 0===a?void 0:null===(n=a.data)||void 0===n?void 0:n.message)||i.message||"Failed to reset password";throw t({authError:e}),Error(e)}finally{t({isAuthenticating:!1})}},verifyEmail:async e=>{t({isAuthenticating:!0,authError:null});try{await new Promise(t=>setTimeout(t,1e3))}catch(a){var i,n;let e=(null===(n=a.response)||void 0===n?void 0:null===(i=n.data)||void 0===i?void 0:i.message)||a.message||"Failed to verify email";throw t({authError:e}),Error(e)}finally{t({isAuthenticating:!1})}}}),{name:"auth-store",partialize:t=>({isAuthenticating:t.isAuthenticating,authError:t.authError})}))),u=(0,n.Ue)()((0,a.mW)((0,a.tJ)(t=>({sidebarOpen:!1,theme:"light",notifications:[],toggleSidebar:()=>t(t=>({sidebarOpen:!t.sidebarOpen})),setTheme:e=>t({theme:e}),addNotification:e=>t(t=>({notifications:[{...e,id:Date.now().toString(),timestamp:new Date},...t.notifications]})),removeNotification:e=>t(t=>({notifications:t.notifications.filter(t=>t.id!==e)})),clearNotifications:()=>t({notifications:[]})}),{name:"ui-store",partialize:t=>({theme:t.theme})})))}}]);