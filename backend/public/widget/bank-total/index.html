<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Donation Total Widget</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .widget-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #00ff00;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .info-card {
            background-color: #3d3d3d;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00ff00;
        }
        .info-card h3 {
            margin: 0 0 10px 0;
            color: #00ff00;
            font-size: 14px;
            text-transform: uppercase;
        }
        .info-card p {
            margin: 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .test-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #3d3d3d;
            border-radius: 8px;
        }
        .test-button {
            background-color: #00ff00;
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #00cc00;
        }
        .test-button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }
        .log {
            background-color: #000000;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .error {
            color: #ff4444;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffaa00;
        }
        .stats-display {
            background-color: #1a1a1a;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            text-align: center;
        }
        .total-amount {
            font-size: 36px;
            font-weight: 700;
            color: #3b82f6;
            margin: 16px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .stat-item {
            background-color: #2d2d2d;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="header">
            <h1>üè¶ Bank Donation Total Widget</h1>
            <div style="background: rgba(255, 0, 0, 0.1); border: 2px solid #ff4444; border-radius: 8px; padding: 15px; margin: 20px 0; color: #ff4444;">
                <h3 style="margin: 0 0 10px 0; color: #ff4444;">‚ö†Ô∏è IMPORTANT: Use HTTP, not HTTPS!</h3>
                <p style="margin: 0; font-size: 14px;">
                    This server only supports HTTP connections. For real-time WebSocket updates, use:<br>
                    <strong>http://14.225.211.248:3001/api/widget-public/bank-total/68cbcda1a8142b7c55edcc3e</strong>
                </p>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Streamer ID</h3>
                <p id="streamerId">Loading...</p>
            </div>
            <div class="info-card">
                <h3>Widget URL</h3>
                <p id="widgetUrl">Loading...</p>
            </div>
            <div class="info-card">
                <h3>Theme</h3>
                <p id="theme">Loading...</p>
            </div>
            <div class="info-card">
                <h3>Show Stats</h3>
                <p id="showStats">Loading...</p>
            </div>
        </div>

        <div class="stats-display" id="statsDisplay" style="display: none;">
            <div class="title">Total Bank Donations</div>
            <div class="total-amount" id="totalAmount">0 VND</div>
            <div class="currency" id="currency">VND</div>
            
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="transactionCount">0</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="averageDonation">0 VND</div>
                    <div class="stat-label">Average</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="todayDonations">0 VND</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="thisWeekDonations">0 VND</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="thisMonthDonations">0 VND</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>
            
            <div class="last-donation" id="lastDonation" style="display: none;">
                Last donation: <span id="lastDonationDate"></span>
            </div>
        </div>

        <div class="test-section">
            <h3>Test Controls</h3>
            <button id="loadStatsBtn" class="test-button">Load Stats</button>
            <button id="refreshBtn" class="test-button">Refresh</button>
            <button id="toggleStatsBtn" class="test-button">Toggle Stats</button>
            
            <div class="log" id="log">
                <div class="success">Widget loaded successfully!</div>
                <div class="info">Extracting streamer ID from URL...</div>
            </div>
        </div>
    </div>

    <script>
        // Extract streamerId from URL
        function extractUrlParams() {
            const path = window.location.pathname;
            const pathParts = path.split('/');
            
            // Expected format: /widget/bank-total/{streamerId}
            if (pathParts.length >= 4 && pathParts[1] === 'widget' && pathParts[2] === 'bank-total') {
                const streamerId = pathParts[3];
                
                if (streamerId) {
                    return { streamerId };
                }
            }
            
            return null;
        }

        // Update UI with extracted parameters
        function updateUI(params) {
            if (params) {
                document.getElementById('streamerId').textContent = params.streamerId;
                document.getElementById('widgetUrl').textContent = window.location.href;
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const theme = urlParams.get('theme') || 'dark';
                const showStats = urlParams.get('showStats') === 'true';
                
                document.getElementById('theme').textContent = theme;
                document.getElementById('showStats').textContent = showStats ? 'Yes' : 'No';
                
                log('success', `Extracted streamer ID: ${params.streamerId}`);
                log('info', `Theme: ${theme}, Show Stats: ${showStats}`);
                
                return params;
            } else {
                log('error', 'Invalid URL format. Expected: /widget/bank-total/{streamerId}');
                document.getElementById('streamerId').textContent = 'Invalid URL';
                document.getElementById('widgetUrl').textContent = 'Invalid URL';
                return null;
            }
        }

        // Logging function
        function log(type, message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Format currency
        function formatCurrency(amount, currency = 'VND') {
            if (currency === 'VND') {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount);
            }
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(amount);
        }

        // Load bank donation stats
        async function loadStats() {
            const params = extractUrlParams();
            if (!params) {
                log('error', 'Cannot load stats: Invalid URL parameters');
                return;
            }

            try {
                log('info', 'Loading bank donation stats...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const showStats = urlParams.get('showStats') === 'true';
                
                const response = await fetch(`/api/widget-public/bank-total/${params.streamerId}?format=json&showStats=${showStats}`);

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayStats(result.data);
                        log('success', `Stats loaded successfully! Total: ${formatCurrency(result.data.totalAmount, result.data.currency)}`);
                    } else {
                        log('error', 'Failed to load stats: ' + result.message);
                    }
                } else {
                    const error = await response.text();
                    log('error', `Failed to load stats: ${error}`);
                }
            } catch (error) {
                log('error', `Error loading stats: ${error.message}`);
            }
        }

        // Display stats
        function displayStats(stats) {
            document.getElementById('totalAmount').textContent = formatCurrency(stats.totalAmount, stats.currency);
            document.getElementById('currency').textContent = stats.currency;
            
            // Show additional stats if available
            if (stats.transactionCount !== undefined) {
                document.getElementById('transactionCount').textContent = stats.transactionCount;
                document.getElementById('averageDonation').textContent = formatCurrency(stats.averageDonation || 0, stats.currency);
                document.getElementById('todayDonations').textContent = formatCurrency(stats.todayDonations || 0, stats.currency);
                document.getElementById('thisWeekDonations').textContent = formatCurrency(stats.thisWeekDonations || 0, stats.currency);
                document.getElementById('thisMonthDonations').textContent = formatCurrency(stats.thisMonthDonations || 0, stats.currency);
                document.getElementById('statsGrid').style.display = 'grid';
            }
            
            if (stats.lastDonationDate) {
                document.getElementById('lastDonationDate').textContent = new Date(stats.lastDonationDate).toLocaleDateString();
                document.getElementById('lastDonation').style.display = 'block';
            }
            
            document.getElementById('statsDisplay').style.display = 'block';
        }

        // Toggle stats display
        function toggleStats() {
            const statsGrid = document.getElementById('statsGrid');
            const isVisible = statsGrid.style.display !== 'none';
            statsGrid.style.display = isVisible ? 'none' : 'grid';
            log('info', `Stats display ${isVisible ? 'hidden' : 'shown'}`);
        }

        // Refresh stats
        function refreshStats() {
            log('info', 'Refreshing stats...');
            loadStats();
        }

        // Initialize widget
        function initWidget() {
            log('info', 'Initializing Bank Donation Total Widget...');
            
            // Check protocol and warn if HTTPS
            if (window.location.protocol === 'https:') {
                log('warning', '‚ö†Ô∏è HTTPS detected! This server only supports HTTP.');
                log('warning', 'For real-time WebSocket updates, use HTTP: http://14.225.211.248:3001/api/widget-public/bank-total/68cbcda1a8142b7c55edcc3e');
            }
            
            const params = updateUI(extractUrlParams());
            if (params) {
                log('success', 'Widget initialized successfully!');
                
                // Load stats automatically
                loadStats();
            } else {
                log('error', 'Widget initialization failed due to invalid URL format');
            }
        }

        // Event listeners
        document.getElementById('loadStatsBtn').addEventListener('click', loadStats);
        document.getElementById('refreshBtn').addEventListener('click', refreshStats);
        document.getElementById('toggleStatsBtn').addEventListener('click', toggleStats);

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initWidget);

        // Auto-refresh every 30 seconds
        setInterval(() => {
            log('info', 'Auto-refreshing stats...');
            loadStats();
        }, 30000);
    </script>
</body>
</html>
